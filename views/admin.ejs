<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Affiliate admin</title>
    <link rel="stylesheet"href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous"referrerpolicy="no-referrer" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" crossorigin="anonymous">
</head>

<body style="background-color: rgb(251, 253, 255); max-width: 100%;">
<!-- waiting dispay -->
    <div id="loadingOverlay" style="
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.4);
    z-index: 2000;
    justify-content: center;
    align-items: center;
">
    <div class="spinner-border text-light" role="status" style="width: 4rem; height: 4rem;">
        <span class="visually-hidden">Loading...</span>
    </div>
</div>




   <div style="position: sticky; top: 10px; background-color: rgb(251, 253, 255); z-index: 1000; padding-bottom: 1rem;">
     <div class="d-flex justify-content-center">
        <h2 class="mt-3">Hello, <%= name %></h2>
    </div>


    <div class="ps-3 mt-5 row g-3">
        <button class="btn btn-secondary me-5 col-md-4 col-8" onclick="getOrders()">Get new orders</button>
        <button class="btn btn-secondary  col-md-4 col-8" onclick="show_user_details_form()">Update pending payment to user</button>
        


    </div>

    <!-- update pending payment form -->

    <div id="user_details_form" class="justify-content-center align-item-center d-flex mt-5 d-none">
            <div style="width: 400px;background-color:white;" class="rounded p-3 shadow">
                <div class="justify-content-end d-flex"><i style="cursor: pointer;" class="fa-solid fa-circle-xmark" onclick="hide_user_details_form()"></i></div>
                <h2 class="text-center">Fill User Details</h2>
                <form id = "updatePaymentForm" method="post">

                    <div class="mt-4">
                        <label for="email" class="form-label mt-">Enter user email <span
                                style="color: brown;">*</span></label>
                        <input type="email" name="email" placeholder="Enter your email" class="form-control" required>
                    </div>

                    <div class="mt-3">
                        <label for="form-label" class="form-label mt-">Enter Order_id <span
                                style="color: brown;">*</span></label>
                        <input type="text" name="order_id" placeholder="Enter Order_id" class="form-control"
                            required>
                    </div>

                    <div class="mt-3">
                        <label for="form-label" class="form-label mt-">Enter Commission <span
                                style="color: brown;">*</span></label>
                        <input type="text" name="commission" placeholder="Enter commission" class="form-control"
                            required>
                    </div>

                    <div class="mt-4 text-center">
                        <button type="submit" class="btn btn-primary w-50 mb-2" onclick="updatePendingPayment()">Update</button><br>

                    </div>
                </form>
            </div>
        </div>

   </div>




<ol class="mt-5" id="orderList"></ol>

<script>
async function getOrders() {
    try {
        const response = await fetch('/admin/api/orders');
        const result = await response.json();

        const list = document.getElementById('orderList');
        list.innerHTML = '';

        if (!result.data || result.data.length === 0) {
            // No orders found
            const li = document.createElement('li');
            li.textContent = 'No orders found.';
            li.style.fontStyle = 'italic';
            list.appendChild(li);
            return;
        }

        result.data.forEach(order => {
            const li = document.createElement('li');
            li.innerHTML = `
        Email: ${order.email}<br>
        Order ID: ${order.order_id}<br>
        Amount: ${order.amount}<br>
        App: ${order.app}<br>
        <br>
    `;

    list.appendChild(li);
        });

    } catch (error) {
        console.error(error);
    }
}


//loader and form submit
function showLoader() {
    document.getElementById('loadingOverlay').style.display = 'flex';
    document.body.style.overflow = 'hidden';
}

function hideLoader() {
    document.getElementById('loadingOverlay').style.display = 'none';
    document.body.style.overflow = '';
}

document.getElementById('updatePaymentForm').addEventListener('submit', async function (e) {
    e.preventDefault(); // üö´ stop normal form submit

    showLoader();

    // const form = new FormData(this);
    const formData = new URLSearchParams(new FormData(this));

    try {
        const response = await fetch('/admin/update_pending_payment', {
            method: 'POST',
             headers: {
        'Content-Type': 'application/x-www-form-urlencoded'
    },
            body: formData
        });

        const result = await response.json();

        hideLoader();

        if (response.ok && result.success) {
            alert('‚úÖ Payment updated successfully');
            this.reset(); // optional
        } else {
            alert('‚ùå Failed: ' + (result.message || 'Something went wrong'));
        }

    } catch (err) {
        hideLoader();
        alert('‚ùå Server error. Please try again.');
        console.error(err);
    }
});



//hide fill user details form 

function hide_user_details_form(){
    document.getElementById('user_details_form').classList.add('d-none');
  }

  function show_user_details_form(){
    document.getElementById('user_details_form').classList.remove('d-none');
  }

</script>

</body>

</html>